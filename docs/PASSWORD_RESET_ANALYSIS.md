# パスワードリセット問題の根本原因分析

## 現象
1. パスワードリセットメールのリンクをクリック
2. `/auth/update-password#access_token=xxx&refresh_token=&type=recovery` に遷移
3. 「リカバリートークンの検証に失敗しました」と表示
4. パスワードを入力すると「セッションが見つかりません」エラー

## 考えられる根本原因

### 1. **Supabaseクライアントの初期化タイミング**
- Next.jsのApp Routerでは、クライアントコンポーネントの初期化が非同期
- ハッシュフラグメントの処理がクライアント初期化前に実行される可能性
- `createClientComponentClient`が複数回呼ばれて別インスタンスになっている

### 2. **ハッシュフラグメントの処理方法**
- Supabaseの自動処理に依存しているが、処理されていない
- `#access_token=xxx`形式が正しく解析されていない
- refresh_tokenが空の場合の処理に問題

### 3. **メールテンプレートのURL形式**
- 現在: `{{ .SiteURL }}/auth/update-password#access_token={{ .Token }}&refresh_token={{ .RefreshToken }}&type=recovery`
- 問題: refresh_tokenが空になっている
- 原因: Supabaseの新しいバージョンではトークン形式が変更された可能性

### 4. **Middleware/SSRの干渉**
- middlewareがハッシュフラグメントを見れない（サーバーサイド）
- クライアントサイドのルーティングと競合
- 複数のリダイレクトが発生している

### 5. **Auth Helpersのバージョン問題**
- `@supabase/auth-helpers-nextjs: ^0.10.0` は古いバージョン
- 最新のSupabaseとの互換性問題
- セッション管理方法が変更されている可能性

### 6. **セッション管理の問題**
- Cookieベースのセッション管理との不整合
- 複数タブ/ウィンドウでの競合
- セッションストレージの同期問題

### 7. **トークンの有効期限**
- リカバリートークンの有効期限が短い
- タイムゾーンの問題
- サーバーとクライアントの時刻のずれ

### 8. **CORS/セキュリティポリシー**
- ハッシュフラグメントが削除される
- ブラウザのセキュリティポリシーによる制限
- リダイレクト時のトークン喪失

## 解決策の優先順位

### 優先度1: 直接的なアプローチ
1. SupabaseのgetSessionFromUrl()メソッドを使用
2. 手動でハッシュフラグメントを解析してセッション設定
3. サーバーサイドでトークンを処理

### 優先度2: パッケージ更新
1. @supabase/auth-helpers-nextjsを最新版に
2. 新しいセッション管理方法を実装

### 優先度3: 代替フロー
1. マジックリンク方式に変更
2. OTPコード方式の実装
3. カスタムトークン処理の実装